<p><span>文本正则过滤: </span><input id="filter" value="." /></p>
<p>
  <!-- 文本输入域 -->
  <textarea id="text" placeholder="文本内容..." cols="35"></textarea>
</p>
<button id="extractText">提取文本</button>
<button id="extractSvg">提取Svg</button>
<button id="toAndroidSvg">toAndroidSvg</button>
<!-- <button id="cancel">关闭</button> -->

<script>
  click("extractText", () => {
    parent.postMessage({ pluginMessage: { type: "extract-text" } }, "*");
  });
  click("cancel", () => {
    parent.postMessage({ pluginMessage: { type: "cancel" } }, "*");
  });
  click("extractSvg", () => {
    parent.postMessage({ pluginMessage: { type: "extractSvg" } }, "*");
  });
  click("toAndroidSvg", () => {
    parent.postMessage({ pluginMessage: { type: "toAndroidSvg" } }, "*");
  });

  //点击事件
  function click(id, callback) {
    const el = document.getElementById(id);
    if (!el) {
      return;
    }
    el.onclick = callback;
  }

  // 接收来自插件的消息
  window.onmessage = (event) => {
    console.log("收到消息↓");
    console.log(event.data.pluginMessage);

    const { type, texts, data } = event.data.pluginMessage;
    if (type === "selected-text") {
      //使用正则过滤texts中的数据
      var filter = document.getElementById("filter").value;
      parent.postMessage(
        { pluginMessage: { type: "putItem", data: filter } },
        "*"
      );

      var reg = new RegExp(filter, "g");
      const newTexts = [];
      texts.forEach((text, index) => {
        //文本是否包含过滤内容
        if (text && text.match(reg)) {
          //包含过滤内容，将过滤内容替换为空
          newTexts.push(`"${text}"`);
        }
      });

      document.getElementById("text").value = newTexts.join("\n");
      //选中所有文本
      //document.getElementById("text").select();
      //设置按钮文本
      document.getElementById("extractText").innerText = `${newTexts.length}`;
    } else if (type === "getItem") {
      //console.log("getItem↓");
      //console.log(data);
      if (data) {
        document.getElementById("filter").value = data;
      }
    } else if (type === "extractSvg") {
      if (data) {
        document.getElementById("text").value = data;
      }
    } else if (type === "toAndroidSvg") {
      if (data) {
        //使用svg xml数据创建dom
        var parser = new DOMParser();
        var doc = parser.parseFromString(data, "image/svg+xml");
        //获取svg节点
        const svg = doc.getElementsByTagName("svg")[0];
        //转成Android Svg xml
        const w = svg.getAttribute("width");
        const h = svg.getAttribute("height");
        //枚举svg节点下的所有child
        const children = svg.children;
        const paths = [];
        for (let i = 0; i < children.length; i++) {
          const child = children[i];
          if (child.tagName === "path") {
            //获取path的d属性
            console.log(child);
            const fillRule = child.getAttribute("fill-rule");
            const d = child.getAttribute("d");
            const fill = child.getAttribute("fill");

            var fillType = "nonZero";
            if (fillRule && fillRule === "evenodd") {
              fillType = "evenOdd";
            }

            paths.push(`
              <path
                  android:fillColor="${fill}"
                  android:fillType="${fillType}"
                  android:pathData="${d}" />
              `);
          }
        }

        var start = `<vector xmlns:android="http://schemas.android.com/apk/res/android"
            android:width="${w}dp"
            android:height="${h}dp"
            android:viewportWidth="${w}"
            android:viewportHeight="${h}">`;
        var end = `</vector>`;

        document.getElementById("text").value = start + paths.join("") + end;

        //释放内存
        doc = null;
        parser = null;
      }
    }
  };
</script>
<!-- 样式 -->
<style>
  body {
    font-family: sans-serif;
    font-size: 12px;
    font-weight: 400;
    color: #333;
    margin: 12px 12px;
    outline: none;
  }
  *:focus {
    outline-color: #30afe6;
  }
  input {
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 4px 4px;
    box-sizing: border-box;
  }
  textarea {
    width: 100%;
    height: 80%;
    padding: 4px 4px;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
  }
  button {
    margin-top: 2px;
    padding: 4px 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    background: #fff;
    cursor: pointer;
  }
</style>
